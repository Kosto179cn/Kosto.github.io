<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线人员与白名单管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 16px;
            color: var(--secondary-color);
            text-align: center;
        }

        .online-list {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .list-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px;
        }

        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px;
            align-items: center;
        }

        .list-item:hover {
            background-color: #f8f9fa;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .block-btn {
            background-color: var(--danger-color);
            color: white;
        }

        .block-btn:hover {
            background-color: #c82333;
        }

        .refresh-btn {
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background-color: #218838;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: var(--secondary-color);
            font-size: 14px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .stats-container {
                flex-direction: column;
            }

            .list-header,
            .list-item {
                grid-template-columns: 1fr 1fr 120px;
            }

            .hidden-sm {
                /* 在手机上不再隐藏这些信息 */
                display: table-cell;
            }

            /* 为小屏幕优化布局 */
            .list-header,
            .list-item {
                grid-template-columns: 1fr 1fr 1fr 1fr 120px;
                font-size: 14px;
            }

            /* 调整列宽以适应小屏幕 */
            @media (max-width: 576px) {
                .list-header,
                .list-item {
                    grid-template-columns: 30% 20% 25% 15% 10%;
                }
            }
        }

        /* 白名单管理相关样式 */
        .nav-tabs {
            margin-top: 20px;
        }

        .tab-content {
            margin-top: 20px;
        }

        .card {
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table {
            margin-bottom: 0;
        }

        .action-buttons {
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="title">在线人员与白名单管理系统</div>
                <button id="refreshBtn" class="refresh-btn">刷新数据</button>
            </div>
        </header>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">当前在线人数</div>
                <div id="currentOnline" class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">今日总人数</div>
                <div id="todayTotal" class="stat-value">0</div>
            </div>
        </div>

        <div class="online-list">
            <div class="list-header">
                <div>用户名</div>
                <div>ID</div>
                <div class="hidden-sm">最后活动</div>
                <div class="hidden-sm">在线时长</div>
                <div>操作</div>
            </div>
            <div id="userList"></div>
        </div>

        <div class="footer">
            <p>数据来源: <a href="https://gitee.com/Kosto179/kosto-battle-clicker-new/blob/master/log.json"
                    target="_blank">https://gitee.com/Kosto179/kosto-battle-clicker-new/blob/master/log.json</a></p>
            <p>上次更新时间: <span id="lastUpdateTime">未更新</span></p>
        </div>

        <!-- 历史活动 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">历史活动</h5>
            </div>
            <div class="card-body">
                <div id="historyList"></div>
            </div>
        </div>

        <!-- 白名单管理 -->
        <ul class="nav nav-tabs" id="whitelistTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tanknames-tab" data-bs-toggle="tab" data-bs-target="#tanknames"
                    type="button" role="tab" aria-controls="tanknames" aria-selected="true"><i
                        class="fas fa-id-card"></i> 白名单用户ID</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button"
                    role="tab" aria-controls="groups" aria-selected="false"><i class="fas fa-users"></i> 白名单军团</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ours-tab" data-bs-toggle="tab" data-bs-target="#ours" type="button"
                    role="tab" aria-controls="ours" aria-selected="false"><i class="fas fa-crown"></i> 开发者ID</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ss-tab" data-bs-toggle="tab" data-bs-target="#ss" type="button"
                    role="tab" aria-controls="ss" aria-selected="false"><i class="fas fa-bomb"></i> 自爆程序标志</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cookie1-tab" data-bs-toggle="tab" data-bs-target="#cookie1" type="button"
                    role="tab" aria-controls="cookie1" aria-selected="false"><i class="fas fa-key"></i> 身份验证Cookie</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button"
                    role="tab" aria-controls="users" aria-selected="false"><i class="fas fa-user"></i> 用户指纹数据</button>
            </li>
        </ul>

        <div class="tab-content" id="whitelistTabsContent">
            <!-- 白名单用户ID -->
            <div class="tab-pane fade show active" id="tanknames" role="tabpanel" aria-labelledby="tanknames-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">白名单用户ID</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addTanknameModal">
                            <i class="fas fa-plus"></i> 添加ID
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>用户ID</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="tanknamesTableBody">
                                    <!-- 数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 白名单军团 -->
            <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">白名单军团</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addGroupModal">
                            <i class="fas fa-plus"></i> 添加军团
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>军团名称</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="groupsTableBody">
                                    <!-- 数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 开发者ID -->
            <div class="tab-pane fade" id="ours" role="tabpanel" aria-labelledby="ours-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">开发者ID</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addOurModal">
                            <i class="fas fa-plus"></i> 添加开发者
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>开发者ID</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="oursTableBody">
                                    <!-- 数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 自爆程序标志 -->
            <div class="tab-pane fade" id="ss" role="tabpanel" aria-labelledby="ss-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">自爆程序标志</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addSsModal">
                            <i class="fas fa-plus"></i> 添加标志
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>标志值</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="ssTableBody">
                                    <!-- 数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 身份验证Cookie -->
            <div class="tab-pane fade" id="cookie1" role="tabpanel" aria-labelledby="cookie1-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">身份验证Cookie</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addCookie1Modal">
                            <i class="fas fa-plus"></i> 添加Cookie
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Cookie值</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="cookie1TableBody">
                                    <!-- 数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户指纹数据 -->
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">用户特定数据</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addUserModal">
                            <i class="fas fa-plus"></i> 添加用户
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>名称</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- 数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加白名单用户ID模态框 -->
        <div class="modal fade" id="addTanknameModal" tabindex="-1" aria-labelledby="addTanknameModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addTanknameModalLabel">添加白名单用户ID</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="tanknameId" class="form-label">用户ID</label>
                            <input type="text" class="form-control" id="tanknameId" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmAddTankname">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑白名单用户ID模态框 -->
        <div class="modal fade" id="editTanknameModal" tabindex="-1" aria-labelledby="editTanknameModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTanknameModalLabel">编辑白名单用户ID</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editTanknameId" class="form-label">用户ID</label>
                            <input type="text" class="form-control" id="editTanknameId" required>
                            <input type="hidden" id="editTanknameIndex">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmEditTankname">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加军团模态框 -->
        <div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addGroupModalLabel">添加军团</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="groupName" class="form-label">军团名称</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmAddGroup">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑军团模态框 -->
        <div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editGroupModalLabel">编辑军团</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editGroupName" class="form-label">军团名称</label>
                            <input type="text" class="form-control" id="editGroupName" required>
                            <input type="hidden" id="editGroupIndex">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmEditGroup">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加开发者ID模态框 -->
        <div class="modal fade" id="addOurModal" tabindex="-1" aria-labelledby="addOurModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addOurModalLabel">添加开发者ID</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="ourId" class="form-label">开发者ID</label>
                            <input type="text" class="form-control" id="ourId" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmAddOur">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑开发者ID模态框 -->
        <div class="modal fade" id="editOurModal" tabindex="-1" aria-labelledby="editOurModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editOurModalLabel">编辑开发者ID</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editOurId" class="form-label">开发者ID</label>
                            <input type="text" class="form-control" id="editOurId" required>
                            <input type="hidden" id="editOurIndex">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmEditOur">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加自爆程序标志模态框 -->
        <div class="modal fade" id="addSsModal" tabindex="-1" aria-labelledby="addSsModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addSsModalLabel">添加自爆程序标志</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="ssValue" class="form-label">标志值</label>
                            <input type="text" class="form-control" id="ssValue" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmAddSs">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加身份验证Cookie模态框 -->
        <div class="modal fade" id="addCookie1Modal" tabindex="-1" aria-labelledby="addCookie1ModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addCookie1ModalLabel">添加身份验证Cookie</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="cookie1Value" class="form-label">Cookie值</label>
                            <input type="text" class="form-control" id="cookie1Value" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmAddCookie1">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑身份验证Cookie模态框 -->
        <div class="modal fade" id="editCookie1Modal" tabindex="-1" aria-labelledby="editCookie1ModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editCookie1ModalLabel">编辑身份验证Cookie</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCookie1Value" class="form-label">Cookie值</label>
                            <input type="text" class="form-control" id="editCookie1Value" required>
                            <input type="hidden" id="editCookie1Index">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmEditCookie1">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加用户模态框 -->
        <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addUserModalLabel">添加用户</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="userId" class="form-label">用户ID</label>
                            <input type="text" class="form-control" id="userId" required>
                        </div>
                        <div class="mb-3">
                            <label for="userName" class="form-label">用户名称</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmAddUser">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑用户模态框 -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUserModalLabel">编辑用户</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editUserId" class="form-label">用户ID</label>
                            <input type="text" class="form-control" id="editUserId" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserName" class="form-label">用户名称</label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <input type="hidden" id="editUserIndex">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmEditUser">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 登录模态窗口 -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="loginModalLabel">请登录</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
                    </div>
                    <div class="modal-body">
                        <p>请输入您的GitHub Token以访问白名单管理系统。</p>
                        <div class="input-group mb-3">
                            <input type="password" id="githubTokenModal" class="form-control" placeholder="GitHub Token">
                        </div>
                        <div class="alert alert-danger" id="invalidTokenAlert" style="display: none;">
                            <p>Token无效或无权限访问文件，请重新输入。</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="confirmLoginBtn">确认登录</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 权限提示 -->
        <div id="permissionError" class="container mt-4" style="display: none;">
            <div class="alert alert-danger">
                <h2>权限不足</h2>
                <p>您的GitHub Token没有编辑1.json的权限，请输入有效的Token。</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 在线人员管理配置
        const CONFIG = {
            LOG_URL: 'https://gitee.com/api/v5/repos/Kosto179/kosto-battle-clicker-new/contents/log.json',
            ONLINE_THRESHOLD_MINUTES: 1.5, // 1分30秒内有活动视为在线
            REFRESH_INTERVAL_MS: 1000, // 自动刷新间隔(毫秒)
        };

        // 存储拉黑名单(基于指纹)
        let blockedFingerprints = new Set();

        // 存储白名单数据
        let whitelistData = [];
        const TANKNAMES_INDEX = 0; // 白名单用户ID在JSON中的索引
        const GROUPS_INDEX = 1;   // 组数据在JSON中的索引
        const OURS_INDEX = 2;     // 开发者ID在JSON中的索引
        const SS_INDEX = 3;       // 自爆程序标志在JSON中的索引
        const COOKIE1_INDEX = 4;  // 身份验证Cookie在JSON中的索引
        const USERS_INDEX = 5;    // 用户数据在JSON中的索引

        // DOM元素
        const userListElement = document.getElementById('userList');
        const historyListElement = document.getElementById('historyList');
        const currentOnlineElement = document.getElementById('currentOnline');
        const todayTotalElement = document.getElementById('todayTotal');
        const lastUpdateTimeElement = document.getElementById('lastUpdateTime');

        // 从本地存储加载拉黑名单
        function loadBlockedUsers() {
            const saved = localStorage.getItem('blockedFingerprints');
            if (saved) {
                blockedFingerprints = new Set(JSON.parse(saved));
            }
        }

        // 保存拉黑名单到本地存储
        function saveBlockedUsers() {
            localStorage.setItem('blockedFingerprints', JSON.stringify([...blockedFingerprints]));
        }

        // 拉黑用户(基于指纹)
        function blockUser(fingerprint, username) {
            blockedFingerprints.add(fingerprint);
            saveBlockedUsers();
            fetchData(); // 重新加载数据以更新列表
            alert(`已拉黑用户: ${username || '未知用户'}`);
        }

        // 显示用户详细信息
        function showUserDetails(user) {
            // 创建详细信息弹窗
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            modal.className = 'detail-modal';

            // 创建弹窗内容
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.borderRadius = '8px';
            modalContent.style.padding = '20px';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '500px';
            modalContent.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';

            // 弹窗标题
            const modalTitle = document.createElement('h3');
            modalTitle.style.marginBottom = '15px';
            modalTitle.style.color = '#4a6cf7';
            modalTitle.textContent = `用户详细信息: ${user.username}`;
            modalContent.appendChild(modalTitle);

            // 弹窗内容
            const detailsList = document.createElement('ul');
            detailsList.style.listStyleType = 'none';
            detailsList.style.marginBottom = '20px';

            // 添加用户信息项
            const createDetailItem = (label, value) => {
                const item = document.createElement('li');
                item.style.marginBottom = '10px';
                item.style.paddingBottom = '10px';
                item.style.borderBottom = '1px solid #eee';
                item.innerHTML = `<strong>${label}:</strong> ${value || '未知'}`;
                return item;
            };

            detailsList.appendChild(createDetailItem('用户名', user.username));
            detailsList.appendChild(createDetailItem('ID', user.getid));
            detailsList.appendChild(createDetailItem('最后活动时间', formatTime(user.timestamp)));
            detailsList.appendChild(createDetailItem('在线时长', `${calculateOnlineTime(user.details?.onlineTime || 0)}分钟`));
            detailsList.appendChild(createDetailItem('指纹', user.fingerprint));
            detailsList.appendChild(createDetailItem('IP地址', user.details?.ip));
            detailsList.appendChild(createDetailItem('浏览器', user.details?.browser));
            detailsList.appendChild(createDetailItem('操作系统', user.details?.os));

            modalContent.appendChild(detailsList);

            // 关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.style.backgroundColor = '#6c757d';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '4px';
            closeBtn.style.padding = '8px 16px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.width = '100%';
            closeBtn.textContent = '关闭';
            closeBtn.onclick = () => {
                document.body.removeChild(modal);
            };

            modalContent.appendChild(closeBtn);
            modal.appendChild(modalContent);

            // 点击空白处关闭弹窗
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };

            document.body.appendChild(modal);
        }

        // 检查用户是否被拉黑
        function isUserBlocked(fingerprint) {
            return blockedFingerprints.has(fingerprint);
        }

        // 格式化时间
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 计算在线时长(分钟)
        function calculateOnlineTime(onlineTimeSeconds) {
            return Math.round(onlineTimeSeconds / 60);
        }

        // 处理数据
        function processData(data) {
            if (!data || !Array.isArray(data)) {
                console.error('数据格式无效');
                return { currentOnlineUsers: [], todayTotalUsers: 0 };
            }

            const now = new Date();
            const offlineThresholdAgo = new Date(now.getTime() - CONFIG.ONLINE_THRESHOLD_MINUTES * 60000);
            const todayStart = new Date(now);
            todayStart.setHours(0, 0, 0, 0);

            // 筛选今日数据
            const todayData = data.filter(item => new Date(item.timestamp) >= todayStart);

            // 获取今日所有唯一用户(基于fingerprint)
            const todayUsers = new Set(todayData.map(item => item.fingerprint || item.username));

            // 筛选当前在线用户(未被拉黑且在阈值时间内有活动)
            const onlineUsers = data.filter(item => {
                const entryTime = new Date(item.timestamp);
                const fingerprint = item.fingerprint || item.username;
                return entryTime >= offlineThresholdAgo && !isUserBlocked(fingerprint);
            });

            // 按fingerprint分组并获取每个用户的最后活动记录
            const userGroups = new Map();
            onlineUsers.forEach(item => {
                const fingerprint = item.fingerprint || item.username;
                if (!userGroups.has(fingerprint) || new Date(item.timestamp) > new Date(userGroups.get(fingerprint).timestamp)) {
                    userGroups.set(fingerprint, item);
                }
            });

            // 转换为数组并排序(按最后活动时间降序)
            const currentOnlineUsers = Array.from(userGroups.values()).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            return {
                currentOnlineUsers,
                todayTotalUsers: todayUsers.size
            };
        }

        // 渲染用户列表
        function renderUserList(users) {
            userListElement.innerHTML = '';

            if (users.length === 0) {
                userListElement.innerHTML = '<div class="list-item"><div colspan="5">当前没有在线用户</div></div>';
                return;
            }

            users.forEach(user => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';

                const lastActiveTime = formatTime(user.timestamp);
                const onlineTime = calculateOnlineTime(user.details?.onlineTime || 0);

                // 格式化小屏幕上的时间显示
                const shortTime = new Date(user.timestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // 处理用户名显示问题
                let displayUsername = user.username;
                // 如果用户名为'unknown'，显示'未知用户'
                if (displayUsername.toLowerCase() === 'unknown') {
                    displayUsername = '未知用户';
                } else {
                    // 尝试处理可能的乱码问题
                    try {
                        // 使用TextDecoder解码可能的乱码
                        const decoder = new TextDecoder('utf-8');
                        const encoded = new TextEncoder().encode(displayUsername);
                        displayUsername = decoder.decode(encoded);
                    } catch (e) {
                        // 如果解码失败，保留原始用户名
                    }
                }

                // 优先使用指纹进行拉黑，如果没有指纹则使用用户名
                const fingerprint = user.fingerprint || user.username;

                // 为用户对象创建唯一标识符
                const userId = fingerprint;
                // 存储用户数据到全局对象，以便详细信息按钮使用
                window.userDetails = window.userDetails || {};
                window.userDetails[userId] = user;

                listItem.innerHTML = `
                    <div><span class="status-indicator status-online"></span>${displayUsername}</div>
                    <div>${user.getid || '未知'}</div>
                    <div class="hidden-sm">${window.innerWidth <= 768 ? shortTime : lastActiveTime}</div>
                    <div class="hidden-sm">${onlineTime}分钟</div>
                    <div>
                        <button class="action-btn block-btn" style="margin-right: 5px;" onclick="blockUser('${fingerprint}', '${displayUsername}')">拉黑</button>
                        <button class="action-btn" style="background-color: #4a6cf7; color: white;" onclick="showUserDetails(window.userDetails['${userId}'])">详情</button>
                    </div>
                `;
                userListElement.appendChild(listItem);
            });
        }

        // 渲染历史活动列表
        function renderHistoryList(data) {
            historyListElement.innerHTML = '';

            if (!data || !Array.isArray(data)) {
                return;
            }

            // 按时间降序排序
            const sortedData = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedData.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';

                const timestamp = formatTime(item.timestamp);
                const username = item.username || '未知用户';

                listItem.innerHTML = `
                    <div><span class="status-indicator status-online"></span>${username}</div>
                    <div>${item.getid || '未知'}</div>
                    <div class="hidden-sm">${timestamp}</div>
                    <div class="hidden-sm">${calculateOnlineTime(item.details?.onlineTime || 0)}分钟</div>
                    <div></div>
                `;
                historyListElement.appendChild(listItem);
            });
        }

        // 更新统计信息
        function updateStats(currentOnline, todayTotal) {
            currentOnlineElement.textContent = currentOnline;
            todayTotalElement.textContent = todayTotal;
            lastUpdateTimeElement.textContent = new Date().toLocaleString('zh-CN');
        }

        // 获取数据
        async function fetchData() {
            try {
                const giteeToken = prompt('请输入Gitee私人令牌');
                if (!giteeToken) {
                    alert('未输入Gitee私人令牌，无法获取数据');
                    return;
                }

                const response = await fetch(CONFIG.LOG_URL, {
                    headers: {
                        'Authorization': `token ${giteeToken}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                const data = await response.json();

                // 处理Gitee API返回的base64编码内容
                let logData;
                if (data.content) {
                    // 解码base64内容
                    const decodedContent = atob(data.content);
                    logData = JSON.parse(decodedContent);
                } else {
                    logData = data;
                }

                const { currentOnlineUsers, todayTotalUsers } = processData(logData);
                renderUserList(currentOnlineUsers);
                renderHistoryList(logData);
                updateStats(currentOnlineUsers.length, todayTotalUsers);

                console.log('数据获取成功');
            } catch (error) {
                console.error('获取数据失败:', error);
                alert(`获取数据失败: ${error.message}`);
            }
        }

        // 初始化
        async function init() {
            loadBlockedUsers();

            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                // 检查权限
                const hasPermission = await checkTokenPermission();
                if (!hasPermission) {
                    showPermissionError();
                    return;
                }
                // 有权限，继续初始化
                await loadWhitelistData();
            } else {
                // 没有Token，显示登录模态窗口
                showLoginPrompt();
            }

            fetchData();

            // 设置自动刷新
            setInterval(fetchData, CONFIG.REFRESH_INTERVAL_MS);

            // 绑定刷新按钮事件
            document.getElementById('refreshBtn').addEventListener('click', fetchData);
        }

        // 加载白名单数据
        async function loadWhitelistData() {
            try {
                // 从GitHub获取白名单数据
                const response = await fetch('https://raw.githubusercontent.com/Kosto179cn/Kosto.github.io/main/js/1/1.json');
                whitelistData = await response.json();

                // 初始化空数组（如果不存在）
                if (!Array.isArray(whitelistData[TANKNAMES_INDEX])) whitelistData[TANKNAMES_INDEX] = [];
                if (!Array.isArray(whitelistData[GROUPS_INDEX])) whitelistData[GROUPS_INDEX] = [];
                if (!Array.isArray(whitelistData[OURS_INDEX])) whitelistData[OURS_INDEX] = [];
                if (!Array.isArray(whitelistData[SS_INDEX])) whitelistData[SS_INDEX] = [];
                if (!Array.isArray(whitelistData[COOKIE1_INDEX])) whitelistData[COOKIE1_INDEX] = [];
                if (!Array.isArray(whitelistData[USERS_INDEX])) whitelistData[USERS_INDEX] = [];

                renderTanknamesTable();
                renderGroupsTable();
                renderOursTable();
                renderSsTable();
                renderCookie1Table();
                renderUsersTable();
            } catch (error) {
                console.error('加载白名单数据失败:', error);
                alert('加载白名单数据失败，请刷新页面重试。');
            }
        }

        // 渲染白名单用户ID表格
        function renderTanknamesTable() {
            const tanknames = whitelistData[TANKNAMES_INDEX] || [];
            const tanknamesTableBody = document.getElementById('tanknamesTableBody');
            tanknamesTableBody.innerHTML = '';

            tanknames.forEach((id, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${id}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-tankname" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-tankname" data-index="${index}">删除</button>
                    </td>
                `;
                tanknamesTableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-tankname').forEach(button => {
                button.addEventListener('click', handleEditTankname);
            });
            document.querySelectorAll('.delete-tankname').forEach(button => {
                button.addEventListener('click', handleDeleteTankname);
            });
        }

        // 处理编辑白名单用户ID
        function handleEditTankname(event) {
            const index = parseInt(event.target.dataset.index);
            const tanknames = whitelistData[TANKNAMES_INDEX] || [];
            const id = tanknames[index];

            document.getElementById('editTanknameId').value = id;
            document.getElementById('editTanknameIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editTanknameModal'));
            modal.show();
        }

        // 确认编辑白名单用户ID
        document.getElementById('confirmEditTankname').addEventListener('click', () => {
            const index = parseInt(document.getElementById('editTanknameIndex').value);
            const newId = document.getElementById('editTanknameId').value.trim();
            if (!newId) return;

            whitelistData[TANKNAMES_INDEX][index] = newId;
            renderTanknamesTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTanknameModal'));
            modal.hide();
        });

        // 处理删除白名单用户ID
        function handleDeleteTankname(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个用户ID吗？')) {
                whitelistData[TANKNAMES_INDEX].splice(index, 1);
                renderTanknamesTable();
            }
        }

        // 处理添加白名单用户ID
        document.getElementById('confirmAddTankname').addEventListener('click', () => {
            const tanknameId = document.getElementById('tanknameId').value.trim();
            if (!tanknameId) return;

            whitelistData[TANKNAMES_INDEX].push(tanknameId);
            renderTanknamesTable();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTanknameModal'));
            modal.hide();
            document.getElementById('tanknameId').value = '';
        });

        // 渲染白名单军团表格
        function renderGroupsTable() {
            const groups = whitelistData[GROUPS_INDEX] || [];
            const groupsTableBody = document.getElementById('groupsTableBody');
            groupsTableBody.innerHTML = '';

            groups.forEach((group, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${group}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-group" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-group" data-index="${index}">删除</button>
                    </td>
                `;
                groupsTableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-group').forEach(button => {
                button.addEventListener('click', handleEditGroup);
            });
            document.querySelectorAll('.delete-group').forEach(button => {
                button.addEventListener('click', handleDeleteGroup);
            });
        }

        // 处理编辑组
        function handleEditGroup(event) {
            const index = parseInt(event.target.dataset.index);
            const groups = whitelistData[GROUPS_INDEX] || [];
            const group = groups[index];

            document.getElementById('editGroupName').value = group;
            document.getElementById('editGroupIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
            modal.show();
        }

        // 确认编辑组
        document.getElementById('confirmEditGroup').addEventListener('click', () => {
            const index = parseInt(document.getElementById('editGroupIndex').value);
            const newGroupName = document.getElementById('editGroupName').value.trim();
            if (!newGroupName) return;

            whitelistData[GROUPS_INDEX][index] = newGroupName;
            renderGroupsTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupModal'));
            modal.hide();
        });

        // 处理删除组
        function handleDeleteGroup(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个军团吗？')) {
                whitelistData[GROUPS_INDEX].splice(index, 1);
                renderGroupsTable();
            }
        }

        // 处理添加组
        document.getElementById('confirmAddGroup').addEventListener('click', () => {
            const groupName = document.getElementById('groupName').value.trim();
            if (!groupName) return;

            whitelistData[GROUPS_INDEX].push(groupName);
            renderGroupsTable();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addGroupModal'));
            modal.hide();
            document.getElementById('groupName').value = '';
        });

        // 渲染开发者ID表格
        function renderOursTable() {
            const ours = whitelistData[OURS_INDEX] || [];
            const oursTableBody = document.getElementById('oursTableBody');
            oursTableBody.innerHTML = '';

            ours.forEach((id, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${id}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-our" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-our" data-index="${index}">删除</button>
                    </td>
                `;
                oursTableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-our').forEach(button => {
                button.addEventListener('click', handleEditOur);
            });
            document.querySelectorAll('.delete-our').forEach(button => {
                button.addEventListener('click', handleDeleteOur);
            });
        }

        // 处理编辑开发者ID
        function handleEditOur(event) {
            const index = parseInt(event.target.dataset.index);
            const ours = whitelistData[OURS_INDEX] || [];
            const id = ours[index];

            document.getElementById('editOurId').value = id;
            document.getElementById('editOurIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editOurModal'));
            modal.show();
        }

        // 确认编辑开发者ID
        document.getElementById('confirmEditOur').addEventListener('click', () => {
            const index = parseInt(document.getElementById('editOurIndex').value);
            const newId = document.getElementById('editOurId').value.trim();
            if (!newId) return;

            whitelistData[OURS_INDEX][index] = newId;
            renderOursTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editOurModal'));
            modal.hide();
        });

        // 处理删除开发者ID
        function handleDeleteOur(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个开发者ID吗？')) {
                whitelistData[OURS_INDEX].splice(index, 1);
                renderOursTable();
            }
        }

        // 处理添加开发者ID
        document.getElementById('confirmAddOur').addEventListener('click', () => {
            const ourId = document.getElementById('ourId').value.trim();
            if (!ourId) return;

            whitelistData[OURS_INDEX].push(ourId);
            renderOursTable();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addOurModal'));
            modal.hide();
            document.getElementById('ourId').value = '';
        });

        // 渲染自爆程序标志表格
        function renderSsTable() {
            const ss = whitelistData[SS_INDEX] || [];
            const ssTableBody = document.getElementById('ssTableBody');
            ssTableBody.innerHTML = '';

            ss.forEach((value, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-ss" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-ss" data-index="${index}">删除</button>
                    </td>
                `;
                ssTableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-ss').forEach(button => {
                button.addEventListener('click', handleEditSs);
            });
            document.querySelectorAll('.delete-ss').forEach(button => {
                button.addEventListener('click', handleDeleteSs);
            });
        }

        // 处理编辑自爆程序标志
        function handleEditSs(event) {
            const index = parseInt(event.target.dataset.index);
            const ss = whitelistData[SS_INDEX] || [];
            const value = ss[index];

            document.getElementById('editSsValue').value = value;
            document.getElementById('editSsIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editSsModal'));
            modal.show();
        }

        // 确认编辑自爆程序标志
        document.getElementById('confirmEditSs').addEventListener('click', () => {
            const index = parseInt(document.getElementById('editSsIndex').value);
            const newValue = document.getElementById('editSsValue').value.trim();
            if (!newValue) return;

            whitelistData[SS_INDEX][index] = newValue;
            renderSsTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSsModal'));
            modal.hide();
        });

        // 处理删除自爆程序标志
        function handleDeleteSs(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个标志吗？')) {
                whitelistData[SS_INDEX].splice(index, 1);
                renderSsTable();
            }
        }

        // 处理添加自爆程序标志
        document.getElementById('confirmAddSs').addEventListener('click', () => {
            const ssValue = document.getElementById('ssValue').value.trim();
            if (!ssValue) return;

            whitelistData[SS_INDEX].push(ssValue);
            renderSsTable();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSsModal'));
            modal.hide();
            document.getElementById('ssValue').value = '';
        });

        // 渲染身份验证Cookie表格
        function renderCookie1Table() {
            const cookie1 = whitelistData[COOKIE1_INDEX] || [];
            const cookie1TableBody = document.getElementById('cookie1TableBody');
            cookie1TableBody.innerHTML = '';

            cookie1.forEach((value, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-cookie1" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-cookie1" data-index="${index}">删除</button>
                    </td>
                `;
                cookie1TableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-cookie1').forEach(button => {
                button.addEventListener('click', handleEditCookie1);
            });
            document.querySelectorAll('.delete-cookie1').forEach(button => {
                button.addEventListener('click', handleDeleteCookie1);
            });
        }

        // 处理编辑身份验证Cookie
        function handleEditCookie1(event) {
            const index = parseInt(event.target.dataset.index);
            const cookie1 = whitelistData[COOKIE1_INDEX] || [];
            const value = cookie1[index];

            document.getElementById('editCookie1Value').value = value;
            document.getElementById('editCookie1Index').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editCookie1Modal'));
            modal.show();
        }

        // 确认编辑身份验证Cookie
        document.getElementById('confirmEditCookie1').addEventListener('click', () => {
            const index = parseInt(document.getElementById('editCookie1Index').value);
            const newValue = document.getElementById('editCookie1Value').value.trim();
            if (!newValue) return;

            whitelistData[COOKIE1_INDEX][index] = newValue;
            renderCookie1Table();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCookie1Modal'));
            modal.hide();
        });

        // 处理删除身份验证Cookie
        function handleDeleteCookie1(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个Cookie吗？')) {
                whitelistData[COOKIE1_INDEX].splice(index, 1);
                renderCookie1Table();
            }
        }

        // 处理添加身份验证Cookie
        document.getElementById('confirmAddCookie1').addEventListener('click', () => {
            const cookie1Value = document.getElementById('cookie1Value').value.trim();
            if (!cookie1Value) return;

            whitelistData[COOKIE1_INDEX].push(cookie1Value);
            renderCookie1Table();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCookie1Modal'));
            modal.hide();
            document.getElementById('cookie1Value').value = '';
        });

        // 渲染用户白名单表格
        function renderUsersTable() {
            const users = whitelistData[USERS_INDEX] || [];
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '';

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user['id:'] || ''}</td>
                    <td>${user['name:'] || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-user" data-index="${index}">编辑</button>
                        <button class="btn btn-sm btn-outline-danger delete-user" data-index="${index}">删除</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });

            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', handleEditUser);
            });
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', handleDeleteUser);
            });
        }

        // 处理编辑用户
        function handleEditUser(event) {
            const index = parseInt(event.target.dataset.index);
            const users = whitelistData[USERS_INDEX] || [];
            const user = users[index];

            document.getElementById('editUserId').value = user['id:'] || '';
            document.getElementById('editUserName').value = user['name:'] || '';
            document.getElementById('editUserIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // 确认编辑用户
        document.getElementById('confirmEditUser').addEventListener('click', () => {
            const index = parseInt(document.getElementById('editUserIndex').value);
            const newUserId = document.getElementById('editUserId').value.trim();
            const newUserName = document.getElementById('editUserName').value.trim();
            if (!newUserId || !newUserName) return;

            whitelistData[USERS_INDEX][index] = {
                'id:': newUserId,
                'name:': newUserName
            };
            renderUsersTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
        });

        // 处理删除用户
        function handleDeleteUser(event) {
            const index = parseInt(event.target.dataset.index);
            if (confirm('确定要删除这个用户吗？')) {
                whitelistData[USERS_INDEX].splice(index, 1);
                renderUsersTable();
            }
        }

        // 处理添加用户
        document.getElementById('confirmAddUser').addEventListener('click', () => {
            const userId = document.getElementById('userId').value.trim();
            const userName = document.getElementById('userName').value.trim();
            if (!userId || !userName) return;

            if (!whitelistData[USERS_INDEX]) {
                whitelistData[USERS_INDEX] = [];
            }
            whitelistData[USERS_INDEX].push({
                'id:': userId,
                'name:': userName
            });
            renderUsersTable();

            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            document.getElementById('userId').value = '';
            document.getElementById('userName').value = '';
        });

        // 保存GitHub Token到本地存储
        document.getElementById('saveTokenBtn').addEventListener('click', async () => {
            const token = document.getElementById('githubToken').value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                // 保存后检查权限
                const hasPermission = await checkTokenPermission();
                if (hasPermission) {
                    alert('Token已保存且验证通过');
                    // 显示主内容并初始化
                    document.querySelector('.container').style.display = 'block';
                    document.getElementById('permissionError').style.display = 'none';
                    document.getElementById('loginPrompt').style.display = 'none';
                    await loadWhitelistData();
                } else {
                    alert('Token无效或无权限访问文件');
                    localStorage.removeItem('githubToken');
                    document.getElementById('githubToken').value = '';
                    showPermissionError();
                }
            } else {
                localStorage.removeItem('githubToken');
                alert('Token已清除');
                showLoginPrompt();
            }
        });

        // 确认登录按钮点击事件
        document.getElementById('confirmLoginBtn').addEventListener('click', async () => {
            const token = document.getElementById('githubTokenModal').value.trim();
            if (!token) {
                document.getElementById('invalidTokenAlert').textContent = '请输入GitHub Token';
                document.getElementById('invalidTokenAlert').style.display = 'block';
                return;
            }

            // 保存Token并检查权限
            localStorage.setItem('githubToken', token);
            document.getElementById('githubToken').value = token;

            const hasPermission = await checkTokenPermission();
            if (hasPermission) {
                // 权限验证通过，关闭模态窗口并初始化
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                loginModal.hide();
                document.querySelector('.container').style.display = 'block';
                document.getElementById('permissionError').style.display = 'none';
                await loadWhitelistData();
            } else {
                // 权限验证失败
                document.getElementById('invalidTokenAlert').textContent = 'Token无效或无权限访问文件，请重新输入。';
                document.getElementById('invalidTokenAlert').style.display = 'block';
                localStorage.removeItem('githubToken');
            }
        });

        // 检查Token是否有权限编辑1.json
        async function checkTokenPermission() {
            const token = localStorage.getItem('githubToken');
            if (!token) return false;

            const apiUrl = 'https://api.github.com/repos/Kosto179cn/Kosto.github.io/contents/js/1/1.json';

            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${encodeURIComponent(token)}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                return response.ok;
            } catch (error) {
                console.error('权限检查失败:', error);
                return false;
            }
        }

        // 显示权限不足错误
        function showPermissionError() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('permissionError').style.display = 'block';
            document.getElementById('loginPrompt').style.display = 'none';
        }

        // 显示登录提示模态窗口
        function showLoginPrompt() {
            // 清空Token输入框
            document.getElementById('githubTokenModal').value = '';
            document.getElementById('invalidTokenAlert').style.display = 'none';
            // 显示模态窗口
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        // 通过GitHub API更新文件
        async function updateGitHubFile(content) {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                alert('请先设置GitHub Token');
                return false;
            }

            const apiUrl = 'https://api.github.com/repos/Kosto179cn/Kosto.github.io/contents/js/1/1.json';
            const base64Content = btoa(unescape(encodeURIComponent(content)));

            try {
                // 先获取文件信息以获取SHA
                const infoResponse = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${encodeURIComponent(token)}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!infoResponse.ok) throw new Error('获取文件信息失败');
                const fileInfo = await infoResponse.json();

                // 更新文件
                const updateResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${encodeURIComponent(token)}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: 'Update whitelist via manager',
                        content: base64Content,
                        sha: fileInfo.sha
                    })
                });

                if (!updateResponse.ok) throw new Error('更新文件失败');
                return true;
            } catch (error) {
                console.error('GitHub API错误:', error);
                alert(`更新失败: ${error.message}`);
                return false;
            }
        }

        // 保存更改
        const saveChangesBtn = document.createElement('button');
        saveChangesBtn.textContent = '保存更改';
        saveChangesBtn.className = 'btn btn-primary';
        saveChangesBtn.addEventListener('click', async function () {
            try {
                var data = JSON.stringify(whitelistData, null, 2);
                const success = await updateGitHubFile(data);
                if (success) {
                    alert('保存到GitHub成功，稍等半分钟/一分钟/两分钟即可');
                }
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        });
        document.querySelector('.container').appendChild(saveChangesBtn);

        // 页面加载完成后初始化
        window.onload = init;

        // 暴露blockUser函数到全局作用域
        window.blockUser = blockUser;
        // 暴露showUserDetails函数到全局作用域
        window.showUserDetails = showUserDetails;
    </script>
</body>

</html>
